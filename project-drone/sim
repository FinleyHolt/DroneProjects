#!/usr/bin/env bash
set -euo pipefail

# Test Drone Simulation Launcher
# Usage: ./sim [build|up|down|shell] [indoor|outdoor]

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

# Default world environment
WORLD_ENV="${2:-outdoor}"

# Enable X11 access for GUI
setup_x11() {
    if command -v xhost >/dev/null 2>&1; then
        xhost +local:docker >/dev/null 2>&1 || true
    fi
    export DISPLAY="${DISPLAY:-:0}"
}

# Commands
case "${1:-up}" in
    build)
        echo "Building simulation image..."
        docker compose -f docker/docker-compose.yml build simulation
        ;;

    up)
        setup_x11

        # Set world based on environment argument
        case "$WORLD_ENV" in
            indoor)
                export WORLD_NAME="indoor_hallway"
                echo "Starting simulation with INDOOR hallway world (SLAM testing)..."
                ;;
            outdoor)
                export WORLD_NAME="outdoor_forest"
                echo "Starting simulation with OUTDOOR forest world..."
                ;;
            *)
                echo "Error: Invalid environment '$WORLD_ENV'"
                echo "Usage: ./sim up [indoor|outdoor]"
                exit 1
                ;;
        esac

        echo "World: $WORLD_NAME"
        docker compose -f docker/docker-compose.yml up simulation
        ;;

    down)
        echo "Stopping simulation..."
        docker compose -f docker/docker-compose.yml down simulation
        ;;

    shell)
        echo "Entering simulation container..."
        docker exec -it test-drone-simulation bash
        ;;

    *)
        echo "Usage: ./sim [build|up|down|shell] [indoor|outdoor]"
        echo ""
        echo "Commands:"
        echo "  build         - Build the simulation Docker image"
        echo "  up [env]      - Start simulation (default: outdoor)"
        echo "  down          - Stop simulation"
        echo "  shell         - Open shell in running container"
        echo ""
        echo "Environments:"
        echo "  indoor        - L-shaped hallway for SLAM testing"
        echo "  outdoor       - Forest environment with trees and obstacles"
        exit 1
        ;;
esac

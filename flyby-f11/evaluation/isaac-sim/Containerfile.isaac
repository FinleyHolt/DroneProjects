# Isaac Sim + Pegasus Simulator + ArduPilot SITL
# For flyby-f11 CV simulation evaluation
#
# Build: podman build -f Containerfile.isaac -t flyby-isaac-sim:4.2.0 .
# Run:   See podman-compose.yml

FROM nvcr.io/nvidia/isaac-sim:4.2.0

LABEL maintainer="Finley Holt"
LABEL description="Isaac Sim with Pegasus Simulator and ArduPilot SITL for drone CV simulation"

# Avoid interactive prompts
ENV DEBIAN_FRONTEND=noninteractive

# Install system dependencies for ArduPilot SITL
RUN apt-get update && apt-get install -y --no-install-recommends \
    git \
    cmake \
    build-essential \
    python3-pip \
    python3-dev \
    python3-future \
    python3-lxml \
    python3-matplotlib \
    python3-numpy \
    python3-opencv \
    python3-pil \
    python3-scipy \
    python3-serial \
    python3-yaml \
    libxml2-dev \
    libxslt1-dev \
    libtool \
    automake \
    autoconf \
    libexpat1-dev \
    wget \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Install Python packages for ArduPilot/MAVLink
RUN pip3 install --no-cache-dir \
    pymavlink \
    MAVProxy \
    kconfiglib \
    empy==3.3.4 \
    pexpect \
    dronecan

# Clone and build ArduPilot SITL
WORKDIR /opt
RUN git clone --recurse-submodules https://github.com/ArduPilot/ardupilot.git \
    && cd ardupilot \
    && git checkout Copter-4.4.0 \
    && git submodule update --init --recursive

WORKDIR /opt/ardupilot
RUN ./waf configure --board sitl \
    && ./waf copter

# Clone Pegasus Simulator
WORKDIR /opt
RUN git clone https://github.com/PegasusSimulator/PegasusSimulator.git \
    && cd PegasusSimulator \
    && git checkout v4.2.0

# Set environment variables
ENV ARDUPILOT_HOME=/opt/ardupilot
ENV PEGASUS_HOME=/opt/PegasusSimulator
ENV PATH="${ARDUPILOT_HOME}/Tools/autotest:${PATH}"

# Create workspace directory
RUN mkdir -p /workspace
WORKDIR /workspace

# Copy Pegasus config (will be mounted at runtime)
# Configuration expects ardupilot_dir to point to /opt/ardupilot

# Expose ports
# MAVLink SITL
EXPOSE 5760/udp
EXPOSE 5761/udp
EXPOSE 14550/udp
EXPOSE 14551/udp
# ROS 2 DDS
EXPOSE 7400-7500/udp

# Entry point script
COPY scripts/start_headless.sh /opt/start_headless.sh
RUN chmod +x /opt/start_headless.sh

# Default command - can be overridden
CMD ["/opt/start_headless.sh"]

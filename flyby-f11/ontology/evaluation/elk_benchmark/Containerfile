# =============================================================================
# ELK Reasoner Benchmark Container
# =============================================================================
#
# Purpose: Runs ELK OWL 2 EL reasoner for ontology classification and benchmarking
#
# ELK is a high-performance reasoner for OWL 2 EL profile with polynomial-time
# classification. It uses OWLAPI for ontology loading.
#
# Build:
#   podman build -t elk-benchmark -f Containerfile .
#
# Run:
#   podman run --rm -v $(pwd):/workspace:Z elk-benchmark
#
# ARM64 (aarch64) Compatibility:
#   This container uses OpenJDK which is fully supported on ARM64/aarch64.
#   No special considerations needed for Jetson deployment.
#
# =============================================================================

# Use Eclipse Temurin (successor to AdoptOpenJDK) for better ARM64 support
# Multi-arch image automatically selects correct platform
FROM docker.io/eclipse-temurin:17-jdk-jammy

LABEL maintainer="Finley Holt"
LABEL description="ELK Reasoner benchmark container for UAV ontology evaluation"
LABEL version="1.0"

# Install dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    wget \
    unzip \
    python3 \
    python3-pip \
    jq \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /opt/elk

# =============================================================================
# Download ELK and OWLAPI
# =============================================================================

# ELK Reasoner (latest stable release)
# ELK is distributed as a standalone JAR with OWLAPI bundled
ENV ELK_VERSION=0.6.0

# Download ELK OWLAPI distribution (includes ELK reasoner + OWLAPI bindings)
RUN wget -q "https://github.com/liveontologies/elk-reasoner/releases/download/v${ELK_VERSION}/elk-distribution-owlapi-${ELK_VERSION}.zip" \
    -O elk.zip \
    && unzip elk.zip \
    && mv elk-distribution-owlapi-${ELK_VERSION} elk-standalone \
    && rm elk.zip

# Also download OWLAPI for our benchmark wrapper
ENV OWLAPI_VERSION=5.1.20

RUN mkdir -p /opt/owlapi \
    && wget -q "https://repo1.maven.org/maven2/net/sourceforge/owlapi/owlapi-distribution/${OWLAPI_VERSION}/owlapi-distribution-${OWLAPI_VERSION}.jar" \
    -O /opt/owlapi/owlapi-distribution.jar

# Download additional dependencies for command-line operation
# Note: Using SLF4J 2.x to match OWLAPI 5.x expectations
RUN mkdir -p /opt/libs \
    && wget -q "https://repo1.maven.org/maven2/org/slf4j/slf4j-api/2.0.13/slf4j-api-2.0.13.jar" \
    -O /opt/libs/slf4j-api.jar \
    && wget -q "https://repo1.maven.org/maven2/org/slf4j/slf4j-simple/2.0.13/slf4j-simple-2.0.13.jar" \
    -O /opt/libs/slf4j-simple.jar \
    && wget -q "https://repo1.maven.org/maven2/com/google/guava/guava/31.1-jre/guava-31.1-jre.jar" \
    -O /opt/libs/guava.jar \
    && wget -q "https://repo1.maven.org/maven2/org/apache/commons/commons-rdf-api/0.5.0/commons-rdf-api-0.5.0.jar" \
    -O /opt/libs/commons-rdf-api.jar \
    && wget -q "https://repo1.maven.org/maven2/javax/inject/javax.inject/1/javax.inject-1.jar" \
    -O /opt/libs/javax.inject.jar \
    && wget -q "https://repo1.maven.org/maven2/javax/annotation/javax.annotation-api/1.3.2/javax.annotation-api-1.3.2.jar" \
    -O /opt/libs/javax.annotation-api.jar \
    && wget -q "https://repo1.maven.org/maven2/com/github/ben-manes/caffeine/caffeine/2.9.3/caffeine-2.9.3.jar" \
    -O /opt/libs/caffeine.jar

# =============================================================================
# Set up Java classpath
# =============================================================================

ENV ELK_HOME=/opt/elk/elk-standalone
# Classpath needs: ELK main jar + ELK lib/ + OWLAPI + additional libs
ENV CLASSPATH="${ELK_HOME}/elk-owlapi-library-0.6.0.jar:${ELK_HOME}/lib/*:/opt/owlapi/*:/opt/libs/*"

# =============================================================================
# Create benchmark Java wrapper
# =============================================================================

# Create source directory
RUN mkdir -p /opt/elk/src

# Copy Java benchmark source (will be created by container build or mounted)
COPY ElkBenchmark.java /opt/elk/src/

# Compile the benchmark wrapper
RUN javac -cp "${CLASSPATH}" -d /opt/elk /opt/elk/src/ElkBenchmark.java || true

# =============================================================================
# Set up workspace
# =============================================================================

WORKDIR /workspace

# Copy benchmark runner script
COPY run_benchmark.sh /opt/elk/
RUN chmod +x /opt/elk/run_benchmark.sh

# Default command
CMD ["/opt/elk/run_benchmark.sh"]

# =============================================================================
# ARM64/aarch64 Build Notes
# =============================================================================
#
# This container is fully compatible with ARM64 (aarch64) including:
# - NVIDIA Jetson Orin NX (flyby-f11 target platform)
# - NVIDIA Jetson Orin Nano Super (project-drone platform)
# - Apple Silicon (M1/M2/M3)
# - AWS Graviton
#
# Key considerations:
# 1. Eclipse Temurin provides native ARM64 JDK builds
# 2. ELK is pure Java - no native dependencies
# 3. OWLAPI is pure Java - no native dependencies
# 4. No JNI or native libraries required
#
# Performance on ARM64:
# - JIT compilation may have different characteristics than x86_64
# - First-run warmup may be longer
# - Steady-state performance should be comparable
#
# Build for ARM64 specifically:
#   podman build --platform linux/arm64 -t elk-benchmark:arm64 -f Containerfile .
#
# Cross-platform build (for registry push):
#   podman manifest create elk-benchmark:multi
#   podman build --platform linux/amd64 -t elk-benchmark:amd64 .
#   podman build --platform linux/arm64 -t elk-benchmark:arm64 .
#   podman manifest add elk-benchmark:multi elk-benchmark:amd64
#   podman manifest add elk-benchmark:multi elk-benchmark:arm64
#
# =============================================================================

# Isaac Sim 5.1.0 + PX4 SITL v1.14.3 + Pegasus Simulator v5.1.0
# MVE for drone simulation with photorealistic rendering
#
# Build: podman build -t isaac-sim-px4:5.1.0 .
# Run:   podman run -d --name px4-sim --device nvidia.com/gpu=all \
#          -e DISPLAY=$DISPLAY -v /tmp/.X11-unix:/tmp/.X11-unix:rw \
#          --network host isaac-sim-px4:5.1.0 bash -c "sleep infinity"
#
# Exec:  podman exec px4-sim /isaac-sim/python.sh /workspace/scripts/fly_mission.py
#
# Note: Isaac Sim 5.1.0 runs as rootless user (isaac-sim:1234) by default.
# PX4 v1.14.3 is recommended by Pegasus Simulator for compatibility.

FROM nvcr.io/nvidia/isaac-sim:5.1.0

# Switch to root for system installations
USER root
ENV DEBIAN_FRONTEND=noninteractive

# Install system dependencies for PX4 build and simulation
# Include GCC 12 for PX4 v1.14.3 compatibility (GCC 13/14 in Ubuntu 24.04 breaks build)
RUN apt-get update && apt-get install -y --no-install-recommends \
    git \
    curl \
    wget \
    python3-pip \
    python3-dev \
    python3-jinja2 \
    python3-numpy \
    python3-toml \
    python3-packaging \
    python3-jsonschema \
    build-essential \
    gcc-12 \
    g++-12 \
    cmake \
    ninja-build \
    lsb-release \
    libgstreamer1.0-dev \
    libgstreamer-plugins-base1.0-dev \
    gstreamer1.0-plugins-base \
    gstreamer1.0-plugins-good \
    gstreamer1.0-plugins-bad \
    gstreamer1.0-plugins-ugly \
    gstreamer1.0-libav \
    libxml2-dev \
    libxslt1-dev \
    libopencv-dev \
    sudo \
    astyle \
    genromfs \
    && rm -rf /var/lib/apt/lists/*

# Set GCC 12 as the default compiler for PX4 build
ENV CC=/usr/bin/gcc-12
ENV CXX=/usr/bin/g++-12

# Install Python packages for PX4 build (system Python - for build tools)
# PX4 v1.14.3 requires empy<4.0 (uses 3.x API)
RUN pip3 install --break-system-packages \
    kconfiglib \
    pyros-genmsg \
    pymavlink \
    pyyaml \
    cerberus \
    requests \
    "empy>=3.3,<4.0" \
    jinja2 \
    jsonschema \
    future \
    nunavut

# Give isaac-sim user sudo access (for debugging)
RUN echo "isaac-sim ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Environment setup
ENV ISAACSIM_PATH="/isaac-sim"
ENV PEGASUS_PATH="/pegasus"
ENV PX4_HOME="/px4"

# Clone Pegasus Simulator v5.1.0
WORKDIR /
RUN git clone --branch v5.1.0 --depth 1 \
    https://github.com/PegasusSimulator/PegasusSimulator.git ${PEGASUS_PATH} && \
    chown -R isaac-sim:isaac-sim ${PEGASUS_PATH}

# Clone PX4-Autopilot v1.14.3 (Pegasus recommended version)
RUN git clone --branch v1.14.3 --recursive \
    https://github.com/PX4/PX4-Autopilot.git ${PX4_HOME} && \
    chown -R isaac-sim:isaac-sim ${PX4_HOME}

# Create workspace directory
RUN mkdir -p /workspace/scripts /workspace/environments /workspace/config && \
    chown -R isaac-sim:isaac-sim /workspace

# Copy scripts before switching user
COPY --chown=isaac-sim:isaac-sim scripts/ /workspace/scripts/

# Copy environments and config for RL training
COPY --chown=isaac-sim:isaac-sim environments/ /workspace/environments/
COPY --chown=isaac-sim:isaac-sim config/ /workspace/config/

# Copy world generator extension
COPY --chown=isaac-sim:isaac-sim extensions/ /workspace/extensions/

# Switch to isaac-sim user for remaining operations
USER isaac-sim

# Build PX4 SITL (headless, no simulator)
WORKDIR ${PX4_HOME}
RUN DONT_RUN=1 make px4_sitl_default

# Create symlink for Pegasus compatibility (expects ~/PX4-Autopilot)
RUN ln -sfn ${PX4_HOME} /isaac-sim/PX4-Autopilot

# Install Python packages in Isaac Sim's Python environment
# This is separate from system Python - Isaac Sim uses its own Python
RUN /isaac-sim/python.sh -m pip install --no-cache-dir \
    pymavlink \
    scipy \
    gymnasium \
    "stable-baselines3[extra]" \
    tensorboard \
    pyyaml

# ============================================================================
# SHADER WARMUP - Pre-compile shaders to avoid runtime compilation overhead
# ============================================================================
# Isaac Sim compiles Vulkan shaders on first run, which takes 2-3 minutes
# and causes high CPU utilization. By running a warmup during build,
# we bake the compiled shaders into the image.
#
# The warmup script:
# 1. Starts Isaac Sim in headless mode
# 2. Loads a basic scene to trigger shader compilation
# 3. Runs for ~60 seconds to let all shaders compile
# 4. Exits cleanly
#
# Shader caches are stored in:
# - /isaac-sim/kit/cache/shadercache (~11MB)
# - /isaac-sim/kit/cache/nv_shadercache (~170MB)
# - /isaac-sim/extscache/omni.hydra.rtx.shadercache.vulkan-*/cache/shadercache (~300MB)

# Create shader warmup script
RUN echo '#!/usr/bin/env python3\n\
"""Shader warmup script - compiles Vulkan shaders during container build."""\n\
import sys\n\
import time\n\
\n\
print("Starting shader warmup...")\n\
print("This will take 60-90 seconds to compile all shaders.")\n\
\n\
# Start Isaac Sim in headless mode\n\
from isaacsim import SimulationApp\n\
simulation_app = SimulationApp({\n\
    "headless": True,\n\
    "width": 1280,\n\
    "height": 720,\n\
    "anti_aliasing": 0,\n\
    "renderer": "RayTracedLighting",  # Force RTX to compile RTX shaders\n\
})\n\
\n\
print("Isaac Sim started, loading scene...")\n\
\n\
# Import after SimulationApp is created\n\
import omni\n\
from omni.isaac.core import World\n\
from omni.isaac.core.objects import DynamicSphere, GroundPlane\n\
from omni.isaac.core.prims import XFormPrim\n\
import numpy as np\n\
\n\
# Create world with physics\n\
world = World(stage_units_in_meters=1.0)\n\
world.scene.add_default_ground_plane()\n\
\n\
# Add some objects to trigger material/shader compilation\n\
for i in range(5):\n\
    sphere = world.scene.add(\n\
        DynamicSphere(\n\
            prim_path=f"/World/Sphere_{i}",\n\
            name=f"sphere_{i}",\n\
            position=np.array([i * 2.0, 0, 1.0]),\n\
            radius=0.5,\n\
            color=np.array([1.0, 0.0, 0.0]),\n\
        )\n\
    )\n\
\n\
print("Scene loaded, warming up shaders...")\n\
\n\
# Reset world to start simulation\n\
world.reset()\n\
\n\
# Run simulation for 60 seconds to compile all shaders\n\
start_time = time.time()\n\
warmup_duration = 60  # seconds\n\
step_count = 0\n\
\n\
while time.time() - start_time < warmup_duration:\n\
    world.step(render=True)\n\
    step_count += 1\n\
    if step_count % 100 == 0:\n\
        elapsed = time.time() - start_time\n\
        print(f"  Warmup progress: {elapsed:.0f}s / {warmup_duration}s")\n\
\n\
print(f"Shader warmup complete! ({step_count} steps)")\n\
\n\
# Clean shutdown\n\
simulation_app.close()\n\
print("Isaac Sim closed successfully.")\n\
' > /tmp/shader_warmup.py

# Run shader warmup (requires GPU during build)
# Note: This step requires --device nvidia.com/gpu=all during podman build
# If building without GPU, comment out this RUN command
RUN /isaac-sim/python.sh /tmp/shader_warmup.py || echo "Shader warmup skipped (no GPU during build)"

# Set working directory
WORKDIR /workspace

# Add PX4 to PATH
ENV PATH="${PX4_HOME}/build/px4_sitl_default/bin:${PATH}"

# Accept EULA by default (required for headless operation)
ENV ACCEPT_EULA=Y
ENV PRIVACY_CONSENT=Y
ENV OMNI_KIT_ACCEPT_EULA=YES

# Expose MAVLink ports
# 14540: PX4 SITL default
# 14550: QGroundControl
# 18570: Lockstep
EXPOSE 14540 14550 18570

# Default: keep container running for exec commands
CMD ["/bin/bash", "-c", "echo 'Isaac Sim + PX4 container ready. Use podman exec to run scripts.' && sleep infinity"]

# ==============================================================================
# Isaac Sim 5.1.0 + PX4 SITL v1.14.3 + Pegasus Simulator v5.1.0
# Flyby F-11 Autonomous ISR Evaluation Environment
# ==============================================================================
#
# CANONICAL IMAGE TAG: localhost/isaac-sim-px4:5.1.0-px4-1.14.3
# This is the SINGLE image tag used across all scripts in this project.
#
# Build (with GPU for shader warmup - RECOMMENDED):
#   podman build --device nvidia.com/gpu=all -t localhost/isaac-sim-px4:5.1.0-px4-1.14.3 .
#
# Build (without GPU - shaders will compile on first run):
#   podman build -t localhost/isaac-sim-px4:5.1.0-px4-1.14.3 .
#
# Run (GUI):
#   xhost +local:
#   podman run -d --name flyby-f11 --device nvidia.com/gpu=all \
#     -e DISPLAY=$DISPLAY -v /tmp/.X11-unix:/tmp/.X11-unix:rw \
#     --network host localhost/isaac-sim-px4:5.1.0-px4-1.14.3
#
# Run (Headless):
#   podman run -d --name flyby-f11 --device nvidia.com/gpu=all \
#     --network host localhost/isaac-sim-px4:5.1.0-px4-1.14.3
#
# Exec:
#   podman exec flyby-f11 /isaac-sim/python.sh /workspace/scripts/phase2_procgen_test.py
#
# ==============================================================================
# CONTAINER CONTENTS
# ==============================================================================
# - Isaac Sim 5.1.0 (NVIDIA Omniverse photorealistic simulation)
# - Pegasus Simulator v5.1.0 (ROS 2 + Isaac Sim drone framework)
# - PX4 Autopilot v1.14.3 SITL (software-in-the-loop flight controller)
# - ROS 2 Jazzy (installed from ROS 2 packages.ros.org)
# - Custom ROS 2 packages: flyby_msgs, flyby_perception, flyby_autonomy
# - YOLO11 (ultralytics) for object detection
# - Stable Baselines3 for reinforcement learning (SAC, PPO, TD3)
# - ByteTrack for multi-object tracking
# - Gymnasium environment wrapper
#
# ==============================================================================
# AIR-GAP DEPLOYMENT NOTES
# ==============================================================================
# This container requires network access during BUILD for:
# 1. apt-get package installation
# 2. pip package installation
# 3. Git clone operations (Pegasus, PX4)
#
# For air-gapped builds, see README.md for offline build instructions.
# ==============================================================================

FROM nvcr.io/nvidia/isaac-sim:5.1.0

# Switch to root for system installations
USER root
ENV DEBIAN_FRONTEND=noninteractive

# ==============================================================================
# INSTALL ROS 2 JAZZY
# ==============================================================================
# Isaac Sim 5.1.0 is based on Ubuntu 24.04 (Noble) which supports ROS 2 Jazzy

# Add ROS 2 repository
RUN apt-get update && apt-get install -y --no-install-recommends \
    software-properties-common \
    gnupg \
    && add-apt-repository universe \
    && curl -sSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.key -o /usr/share/keyrings/ros-archive-keyring.gpg \
    && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/ros-archive-keyring.gpg] http://packages.ros.org/ros2/ubuntu $(. /etc/os-release && echo $UBUNTU_CODENAME) main" | tee /etc/apt/sources.list.d/ros2.list > /dev/null \
    && rm -rf /var/lib/apt/lists/*

# Install ROS 2 Jazzy base (not desktop - we don't need GUI tools)
RUN apt-get update && apt-get install -y --no-install-recommends \
    ros-jazzy-ros-base \
    ros-jazzy-cv-bridge \
    ros-jazzy-image-transport \
    ros-jazzy-sensor-msgs \
    ros-jazzy-geometry-msgs \
    ros-jazzy-nav-msgs \
    ros-jazzy-std-srvs \
    python3-colcon-common-extensions \
    python3-rosdep \
    && rm -rf /var/lib/apt/lists/*

# Install system dependencies for PX4 build and simulation
# Include GCC 12 for PX4 v1.14.3 compatibility (GCC 13/14 in Ubuntu 24.04 breaks build)
RUN apt-get update && apt-get install -y --no-install-recommends \
    git \
    curl \
    wget \
    python3-pip \
    python3-dev \
    python3-jinja2 \
    python3-numpy \
    python3-toml \
    python3-packaging \
    python3-jsonschema \
    build-essential \
    gcc-12 \
    g++-12 \
    cmake \
    ninja-build \
    lsb-release \
    libgstreamer1.0-dev \
    libgstreamer-plugins-base1.0-dev \
    gstreamer1.0-plugins-base \
    gstreamer1.0-plugins-good \
    gstreamer1.0-plugins-bad \
    gstreamer1.0-plugins-ugly \
    gstreamer1.0-libav \
    libxml2-dev \
    libxslt1-dev \
    libopencv-dev \
    sudo \
    astyle \
    genromfs \
    && rm -rf /var/lib/apt/lists/*

# Set GCC 12 as the default compiler for PX4 build
ENV CC=/usr/bin/gcc-12
ENV CXX=/usr/bin/g++-12

# Install Python packages for PX4 build (system Python - for build tools)
# PX4 v1.14.3 requires empy<4.0 (uses 3.x API)
RUN pip3 install --break-system-packages \
    kconfiglib \
    pyros-genmsg \
    pymavlink \
    pyyaml \
    cerberus \
    requests \
    "empy>=3.3,<4.0" \
    jinja2 \
    jsonschema \
    future \
    nunavut

# Install perception stack for ROS 2 nodes (system Python)
# ultralytics for YOLO, numpy 1.26.4 for Isaac Sim compatibility
RUN pip3 install --break-system-packages \
    "numpy==1.26.4" \
    ultralytics \
    lap \
    Pillow \
    opencv-python-headless

# Give isaac-sim user sudo access (for debugging)
RUN echo "isaac-sim ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Environment setup
ENV ISAACSIM_PATH="/isaac-sim"
ENV PEGASUS_PATH="/pegasus"
ENV PX4_HOME="/px4"
ENV YOLO_MODEL_PATH="/workspace/models/yolo11x.pt"

# Clone Pegasus Simulator v5.1.0
WORKDIR /
RUN git clone --branch v5.1.0 --depth 1 \
    https://github.com/PegasusSimulator/PegasusSimulator.git ${PEGASUS_PATH} && \
    chown -R isaac-sim:isaac-sim ${PEGASUS_PATH}

# Clone PX4-Autopilot v1.14.3 (Pegasus recommended version)
RUN git clone --branch v1.14.3 --recursive \
    https://github.com/PX4/PX4-Autopilot.git ${PX4_HOME} && \
    chown -R isaac-sim:isaac-sim ${PX4_HOME}

# Create workspace directory
RUN mkdir -p /workspace/scripts /workspace/environments /workspace/config && \
    chown -R isaac-sim:isaac-sim /workspace

# Copy scripts before switching user
COPY --chown=isaac-sim:isaac-sim scripts/ /workspace/scripts/

# Copy environments and config for RL training
COPY --chown=isaac-sim:isaac-sim environments/ /workspace/environments/
COPY --chown=isaac-sim:isaac-sim config/ /workspace/config/

# Copy world generator extension
COPY --chown=isaac-sim:isaac-sim extensions/ /workspace/extensions/

# Copy perception module (YOLO detector, ByteTrack tracking, frustum culling)
COPY --chown=isaac-sim:isaac-sim perception/ /workspace/perception/

# Copy tests for in-container testing
COPY --chown=isaac-sim:isaac-sim tests/ /workspace/tests/

# ==============================================================================
# ROS 2 WORKSPACE
# ==============================================================================
# Copy ROS 2 packages from the main workspace
# These provide sim-to-deployment parity with real hardware
#
# NOTE: ROS 2 packages must be copied to ros2_packages/ before building:
#   cp -r ../../ros2_ws/src/flyby_msgs ros2_packages/
#   cp -r ../../ros2_ws/src/flyby_perception ros2_packages/
#   cp -r ../../ros2_ws/src/flyby_autonomy ros2_packages/
#
# Or use the build script: ./scripts/build_container.sh

# Create ROS 2 workspace
RUN mkdir -p /workspace/ros2_ws/src && \
    chown -R isaac-sim:isaac-sim /workspace/ros2_ws

# Copy ROS 2 packages (from ros2_packages/ in build context)
COPY --chown=isaac-sim:isaac-sim ros2_packages/flyby_msgs/ /workspace/ros2_ws/src/flyby_msgs/
COPY --chown=isaac-sim:isaac-sim ros2_packages/flyby_perception/ /workspace/ros2_ws/src/flyby_perception/
COPY --chown=isaac-sim:isaac-sim ros2_packages/flyby_autonomy/ /workspace/ros2_ws/src/flyby_autonomy/

# Create output directories with correct ownership
RUN mkdir -p /workspace/checkpoints /workspace/logs /workspace/output /workspace/models && \
    chown -R isaac-sim:isaac-sim /workspace/checkpoints /workspace/logs /workspace/output /workspace/models

# Copy YOLO model weights if present (114MB - required for perception pipeline)
# If not present during build, mount at runtime: -v ./yolo11x.pt:/workspace/models/yolo11x.pt
COPY --chown=isaac-sim:isaac-sim yolo11x.pt /workspace/models/yolo11x.pt

# Switch to isaac-sim user for remaining operations
USER isaac-sim

# Build PX4 SITL (headless, no simulator)
WORKDIR ${PX4_HOME}
RUN DONT_RUN=1 make px4_sitl_default

# Create symlink for Pegasus compatibility (expects ~/PX4-Autopilot)
RUN ln -sfn ${PX4_HOME} /isaac-sim/PX4-Autopilot

# Install Python packages in Isaac Sim's Python environment
# This is separate from system Python - Isaac Sim uses its own Python
# CRITICAL: numpy 1.26.4 required - numpy 2.x causes dtype errors in Isaac Sim headless mode
RUN /isaac-sim/python.sh -m pip install --no-cache-dir \
    "numpy==1.26.4" \
    pymavlink \
    scipy \
    gymnasium \
    "stable-baselines3[extra]" \
    tensorboard \
    pyyaml \
    ultralytics \
    lap \
    Pillow

# ==============================================================================
# BUILD ROS 2 WORKSPACE
# ==============================================================================
# Build our custom ROS 2 packages for the perception and autonomy stack.
# Note: ROS 2 Jazzy was installed above; we use colcon build from python3-colcon-common-extensions

# Source ROS 2 Jazzy and build workspace
WORKDIR /workspace/ros2_ws
RUN /bin/bash -c "source /opt/ros/jazzy/setup.bash && \
    colcon build --symlink-install --cmake-args -DCMAKE_BUILD_TYPE=Release"

# Add ROS 2 workspace to environment
# Note: ROS 2 Jazzy on Ubuntu 24.04 uses Python 3.12
ENV ROS2_WS="/workspace/ros2_ws"
ENV ROS_DISTRO="jazzy"
ENV AMENT_PREFIX_PATH="/workspace/ros2_ws/install:${AMENT_PREFIX_PATH}"
ENV CMAKE_PREFIX_PATH="/workspace/ros2_ws/install:${CMAKE_PREFIX_PATH}"
# ROS 2 packages installed to python3.12 site-packages
ENV PYTHONPATH="/workspace/ros2_ws/install/flyby_msgs/local/lib/python3.12/dist-packages:/workspace/ros2_ws/install/flyby_perception/local/lib/python3.12/dist-packages:/workspace/ros2_ws/install/flyby_autonomy/local/lib/python3.12/dist-packages:${PYTHONPATH}"

# ==============================================================================
# ISAAC SIM ROS 2 BRIDGE CONFIGURATION
# ==============================================================================
# Isaac Sim includes its own ROS 2 Jazzy libraries in the isaacsim.ros2.bridge
# extension. These must be in LD_LIBRARY_PATH for the bridge to work.
# Using FastDDS (default RMW implementation).
ENV RMW_IMPLEMENTATION="rmw_fastrtps_cpp"
ENV LD_LIBRARY_PATH="/isaac-sim/exts/isaacsim.ros2.bridge/jazzy/lib:${LD_LIBRARY_PATH}"

# ============================================================================
# SHADER WARMUP - Pre-compile shaders to avoid runtime compilation overhead
# ============================================================================
# Isaac Sim compiles Vulkan shaders on first run, which takes 2-3 minutes.
# By running NVIDIA's official warmup script during build, we bake the
# compiled shaders into the image for instant starts.
#
# Uses NVIDIA's official /isaac-sim/warmup.sh which:
# 1. Runs hello_world.py for Python app shader cache
# 2. Runs Kit in warmup mode with --/app/warmupMode=1
# 3. Compiles all shaders with proper flags
#
# BUILD REQUIREMENTS:
#   podman build --device nvidia.com/gpu=all -t <tag> .
#
# If building without GPU access, the warmup will be skipped.
#
# Shader caches are stored in:
# - /isaac-sim/kit/cache/shadercache (~11MB)
# - /isaac-sim/kit/cache/nv_shadercache (~170MB)
# - /isaac-sim/extscache/omni.hydra.rtx.shadercache.vulkan-*/cache/shadercache

# Run NVIDIA's official shader warmup (requires GPU during build)
# Note: Building with GPU: podman build --device nvidia.com/gpu=all -t <tag> .
RUN /isaac-sim/warmup.sh || echo "Shader warmup skipped (no GPU during build - run warmup.sh manually on first container start)"

# Set working directory
WORKDIR /workspace

# Add PX4 to PATH
ENV PATH="${PX4_HOME}/build/px4_sitl_default/bin:${PATH}"

# Accept EULA by default (required for headless operation)
ENV ACCEPT_EULA=Y
ENV PRIVACY_CONSENT=Y
ENV OMNI_KIT_ACCEPT_EULA=YES

# Expose MAVLink ports
# 14540: PX4 SITL default
# 14550: QGroundControl
# 18570: Lockstep
EXPOSE 14540 14550 18570

# Default: keep container running for exec commands
CMD ["/bin/bash", "-c", "echo 'Isaac Sim + PX4 container ready. Use podman exec to run scripts.' && sleep infinity"]
